name: Flutter Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'
          channel: 'stable'
          
      - name: Install dependencies
        run: flutter pub get
        
      - name: Analyze code
        run: flutter analyze
        
      - name: Format check
        run: dart format --set-exit-if-changed .
        
      - name: Run tests with coverage
        id: run-tests
        run: |
          flutter test --coverage --reporter=json > test-results.json
          flutter test --coverage --reporter=compact > test-results.txt
          echo "exit_code=$?" >> $GITHUB_OUTPUT
          
      - name: Generate coverage report
        if: steps.run-tests.outputs.exit_code == '0'
        run: |
          genhtml coverage/lcov.info -o coverage/html
          
      - name: Upload coverage to Codecov
        if: steps.run-tests.outputs.exit_code == '0'
        uses: codecov/codecov-action@v3
        with:
          file: coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          
      - name: Upload coverage report as artifact
        if: steps.run-tests.outputs.exit_code == '0'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/html/
          
      - name: Comment test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // ãƒ†ã‚¹ãƒˆçµæœã‚’èª­ã¿å–ã‚Š
            let testOutput = '';
            try {
              testOutput = fs.readFileSync('test-results.txt', 'utf8');
            } catch (error) {
              testOutput = 'ãƒ†ã‚¹ãƒˆçµæœãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
            }
            
            // ãƒ†ã‚¹ãƒˆæˆåŠŸ/å¤±æ•—ã‚’åˆ¤å®š
            const testSuccess = '${{ steps.run-tests.outputs.exit_code }}' === '0';
            const statusEmoji = testSuccess ? 'âœ…' : 'âŒ';
            const statusText = testSuccess ? 'æˆåŠŸ' : 'å¤±æ•—';
            
            // JSONçµæœã‚’è§£æ
            let testSummary = '';
            try {
              const jsonResults = JSON.parse(fs.readFileSync('test-results.json', 'utf8'));
              const totalTests = jsonResults.length;
              const passedTests = jsonResults.filter(test => test.result === 'success').length;
              const failedTests = totalTests - passedTests;
              
              testSummary = `ğŸ“Š **ãƒ†ã‚¹ãƒˆã‚µãƒãƒªãƒ¼**: ${passedTests}/${totalTests} ãƒ†ã‚¹ãƒˆæˆåŠŸ`;
              if (failedTests > 0) {
                testSummary += ` (${failedTests} å¤±æ•—)`;
              }
            } catch (error) {
              testSummary = 'ğŸ“Š **ãƒ†ã‚¹ãƒˆã‚µãƒãƒªãƒ¼**: è§£æã§ãã¾ã›ã‚“ã§ã—ãŸ';
            }
            
            // ã‚«ãƒãƒ¬ãƒƒã‚¸æƒ…å ±ã‚’å–å¾—ï¼ˆæˆåŠŸæ™‚ã®ã¿ï¼‰
            let coverageInfo = '';
            if (testSuccess) {
              try {
                const lcovContent = fs.readFileSync('coverage/lcov.info', 'utf8');
                const lines = lcovContent.split('\n');
                let totalLines = 0;
                let coveredLines = 0;
                
                lines.forEach(line => {
                  if (line.startsWith('SF:')) {
                    // ãƒ•ã‚¡ã‚¤ãƒ«é–‹å§‹
                  } else if (line.startsWith('LF:')) {
                    // ç·è¡Œæ•°
                    totalLines += parseInt(line.split(':')[1]);
                  } else if (line.startsWith('LH:')) {
                    // ã‚«ãƒãƒ¼ã•ã‚ŒãŸè¡Œæ•°
                    coveredLines += parseInt(line.split(':')[1]);
                  }
                });
                
                const coverage = totalLines > 0 ? ((coveredLines / totalLines) * 100).toFixed(2) : 0;
                coverageInfo = `ğŸ“ˆ **ã‚«ãƒãƒ¬ãƒƒã‚¸**: ${coverage}% (${coveredLines}/${totalLines} è¡Œ)`;
              } catch (error) {
                coverageInfo = ' **ã‚«ãƒãƒ¬ãƒƒã‚¸**: è¨ˆç®—ã§ãã¾ã›ã‚“ã§ã—ãŸ';
              }
            }
            
            const comment = `## ğŸ§ª ãƒ†ã‚¹ãƒˆçµæœ
            
            ${statusEmoji} **ãƒ†ã‚¹ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${statusText}
            
            ${testSummary}
            ${coverageInfo}
            
            ### ğŸ“‹ å®Ÿè¡Œã•ã‚ŒãŸãƒã‚§ãƒƒã‚¯
            - âœ… ã‚³ãƒ¼ãƒ‰åˆ†æ (flutter analyze)
            - âœ… ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯ (dart format)
            - ${testSuccess ? 'âœ…' : 'âŒ'} å˜ä½“ãƒ†ã‚¹ãƒˆ (flutter test)
            - ${testSuccess ? 'âœ…' : 'âŒ'} ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®š
            
            ${testSuccess ? `### ğŸ“ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ
            ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã¯ [Artifacts](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚` : ''}
            
            ### ğŸ” ãƒ†ã‚¹ãƒˆè©³ç´°
            \`\`\`
            ${testOutput}
            \`\`\`
            
            ${!testSuccess ? '###  ä¿®æ­£ãŒå¿…è¦
            ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¦ã„ã¾ã™ã€‚ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚' : ''}
            
            ---
            *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            }); 